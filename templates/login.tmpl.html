{{ define "content" }}

  <div id="content"></div>

  <script type="text/babel">
    var Input = ReactBootstrap.Input;
    var Button = ReactBootstrap.Button;
    var ProgressBar = ReactBootstrap.ProgressBar;
    var Login = React.createClass({
      getInitialState() {
        return {
          emailText: '',
          passwordText: '',
          importing: false
        };
      },
      validationState() {
        let email = this.state.emailText;
        if (email.length < 3) return;
        let re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        let match = re.test(email);
        if (match) return 'success';
        return 'warning';
      },
      handleChange() {
        this.setState({
          emailText: this.refs.email.getValue(),
          passwordText: this.refs.password.getValue()
        });
      },
      handleClick() {
        var self = this;
        self.setState({
          importing: true,
          message: ""
        });
        let username = this.state.emailText;
        let password = this.state.passwordText;
        window.superagent
          .get('/auth')
          .auth(username, password)
          .end(function(err, res){
            if (err || res.code != 200) {
              self.setState({
                importing: false,
                message: "Invalid Credentials"
              });
            } else {
              window.superagent
                .post('/import')
                .auth(username, password)
                .end(function(err, res){
                  if (err || res.code != 200) {
                    self.setState({
                      importing: false,
                      message: "Import Failed"
                    });
                  } else {
                    self.setState({
                      importing: false,
                      message: "Import Succeeded!"
                    });
                  }
                });
            }
          });
      },
      render: function() {
        var button;
        if (this.state.importing) {
          button = <ProgressBar active now={100}/>
        } else {
          button = <Button bsStyle="primary" onClick={this.handleClick}>Import</Button>
        }

        var message = this.state.message;

        return (
          <div>
            <Input
              type="text"
              value={this.state.emailText}
              placeholder="Instapaper Email"
              label="Email"
              bsStyle={this.validationState()}
              hasFeedback
              ref="email"
              groupClassName="group-class"
              labelClassName="label-class"
              onChange={this.handleChange} />

            <Input
              type="password"
              value={this.state.passwordText}
              placeholder="Instapaper Password"
              label="Pasword"
              hasFeedback
              ref="password"
              groupClassName="group-class"
              labelClassName="label-class"
              onChange={this.handleChange} />

            {button}

            {message}
          </div>
        );
      }
    });

    ReactDOM.render(<Login />, document.getElementById('content'));
  </script>

{{ end }}
